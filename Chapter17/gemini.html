<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√¢n t√≠ch ƒê√°nh gi√° t·ª´ Excel</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 10px; }
        
        /* Style cho n√∫t upload */
        .upload-area {
            border: 2px dashed #667eea;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 10px;
            background-color: #f8faff;
            transition: all 0.3s;
        }
        .upload-area:hover { background-color: #eef2ff; }
        input[type="file"] { font-size: 1.1em; cursor: pointer; }

        /* Style cho ph·∫ßn k·∫øt qu·∫£ */
        .results-box { display: none; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; } /* M·∫∑c ƒë·ªãnh ·∫©n cho ƒë·∫øn khi upload */
        .card { flex: 1; padding: 20px; border-radius: 8px; color: white; min-width: 300px; }
        .card.winner { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card.longest { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color: #333; }
        .card h2 { margin-top: 0; font-size: 1.2em; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px; }
        .card.longest h2 { border-bottom: 1px solid rgba(0,0,0,0.1); }
        .highlight { font-size: 2.5em; font-weight: bold; display: block; margin: 10px 0; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; display: none; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .comment-cell { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #666; }
        
        /* Error message */
        #error-msg { color: red; text-align: center; display: none; font-weight: bold; margin-top: 10px;}
    </style>
</head>
<body>

<div class="container">
    <h1>C√¥ng C·ª• Ph√¢n T√≠ch ƒêi·ªÉm & Comment</h1>
    <p style="text-align: center; color: #666; margin-bottom: 20px;">T·∫£i l√™n file Excel (.xlsx) ch·ª©a b·∫£ng ƒëi·ªÉm Cross-review</p>

    <div class="upload-area">
        <input type="file" id="fileInput" accept=".xlsx, .xls" />
        <p style="font-size: 0.9em; color: #888; margin-top: 10px;">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ƒë·ªçc c√°c c·ªôt: "Nh√≥m ƒë∆∞·ª£c ch·∫•m", "T·ªïng ƒëi·ªÉm", "Nh·∫≠n x√©t chi ti·∫øt"</p>
    </div>
    <div id="error-msg"></div>

    <div class="results-box" id="results-area">
        <div class="card winner">
            <h2>üèÜ Nh√≥m c√≥ ƒëi·ªÉm TB cao nh·∫•t</h2>
            <span id="highest-group" class="highlight">...</span>
            <p id="highest-score">ƒêi·ªÉm trung b√¨nh: ...</p>
        </div>

        <div class="card longest">
            <h2>üí¨ Nh√≥m c√≥ comment d√†i nh·∫•t</h2>
            <span id="longest-group" class="highlight">...</span>
            <p>ƒê·ªô d√†i: <span id="longest-length">...</span> k√Ω t·ª±</p>
            <p style="font-style: italic; font-size: 0.9em; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 5px;">
                "<span id="longest-content">...</span>"
            </p>
        </div>
    </div>

    <table id="data-table">
        <thead>
            <tr>
                <th>STT</th>
                <th>Nh√≥m ƒë∆∞·ª£c ch·∫•m</th>
                <th>T·ªïng ƒëi·ªÉm</th>
                <th>Nh·∫≠n x√©t (Tr√≠ch ƒëo·∫°n)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    // L·∫Øng nghe s·ª± ki·ªán khi ng∆∞·ªùi d√πng ch·ªçn file
    document.getElementById('fileInput').addEventListener('change', handleFile);

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        
        reader.onload = function(event) {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});

                // L·∫•y sheet ƒë·∫ßu ti√™n trong file excel
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Chuy·ªÉn ƒë·ªïi sheet th√†nh d·∫°ng JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) {
                    showError("File Excel kh√¥ng c√≥ d·ªØ li·ªáu!");
                    return;
                }

                // X·ª≠ l√Ω d·ªØ li·ªáu
                processExcelData(jsonData);

            } catch (error) {
                console.error(error);
                showError("ƒê√£ x·∫£y ra l·ªói khi ƒë·ªçc file. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file.");
            }
        };

        reader.readAsArrayBuffer(file);
    }

    function showError(msg) {
        const el = document.getElementById('error-msg');
        el.textContent = msg;
        el.style.display = 'block';
    }

    function processExcelData(data) {
        document.getElementById('error-msg').style.display = 'none';
        
        // Chu·∫©n h√≥a d·ªØ li·ªáu t·ª´ c√°c t√™n c·ªôt c√≥ th·ªÉ c√≥ trong file Excel
        // L∆∞u √Ω: T√™n c·ªôt trong file Excel ph·∫£i CH√çNH X√ÅC (ho·∫∑c b·∫°n c√≥ th·ªÉ s·ª≠a code d∆∞·ªõi ƒë√¢y cho kh·ªõp)
        const formattedData = data.map(row => {
            // T√¨m c√°c key t∆∞∆°ng ·ª©ng d√π c√≥ kho·∫£ng tr·∫Øng hay ch·ªØ hoa th∆∞·ªùng
            const keys = Object.keys(row);
            
            // Helper function t√¨m key g·∫ßn ƒë√∫ng
            const findKey = (keyword) => keys.find(k => k.toLowerCase().includes(keyword.toLowerCase()));

            // Mapping d·ª±a tr√™n h√¨nh ·∫£nh b·∫°n cung c·∫•p
            // C·ªôt C: "Nh√≥m ƒë∆∞·ª£c ch·∫•m"
            // C·ªôt D: "T·ªïng ƒëi·ªÉm"
            // C·ªôt O: "Nh·∫≠n x√©t chi ti·∫øt"
            const groupKey = findKey("Nh√≥m ƒë∆∞·ª£c ch·∫•m") || findKey("Nh√≥m") || "Nh√≥m ƒë∆∞·ª£c ch·∫•m"; 
            const scoreKey = findKey("T·ªïng ƒëi·ªÉm") || "T·ªïng ƒëi·ªÉm";
            const commentKey = findKey("Nh·∫≠n x√©t") || "Nh·∫≠n x√©t chi ti·∫øt";

            return {
                target: row[groupKey], // Nh√≥m ƒë∆∞·ª£c ch·∫•m
                score: parseFloat(row[scoreKey]) || 0, // T·ªïng ƒëi·ªÉm
                comment: row[commentKey] ? String(row[commentKey]) : "" // Comment
            };
        }).filter(item => item.target !== undefined); // L·ªçc b·ªè c√°c d√≤ng kh√¥ng c√≥ t√™n nh√≥m

        // G·ªçi h√†m ph√¢n t√≠ch v√† hi·ªÉn th·ªã
        analyzeAndRender(formattedData);
    }

    function analyzeAndRender(data) {
        const groupScores = {}; 
        let maxCommentLength = 0;
        let longestCommentGroup = "N/A";
        let longestCommentContent = "";

        // X√≥a d·ªØ li·ªáu b·∫£ng c≈©
        const tableBody = document.querySelector('#data-table tbody');
        tableBody.innerHTML = '';

        data.forEach((row, index) => {
            // --- Logic t√≠nh ƒëi·ªÉm trung b√¨nh ---
            if (row.target) {
                if (!groupScores[row.target]) {
                    groupScores[row.target] = { total: 0, count: 0 };
                }
                groupScores[row.target].total += row.score;
                groupScores[row.target].count += 1;
            }

            // --- Logic t√¨m comment d√†i nh·∫•t ---
            const commentText = row.comment.trim();
            if (commentText.length > maxCommentLength) {
                maxCommentLength = commentText.length;
                longestCommentGroup = row.target;
                longestCommentContent = commentText;
            }

            // --- Render b·∫£ng chi ti·∫øt ---
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${row.target}</td>
                <td>${row.score}</td>
                <td class="comment-cell" title="${row.comment}">${row.comment || ""}</td>
            `;
            tableBody.appendChild(tr);
        });

        // T√¨m nh√≥m c√≥ ƒëi·ªÉm TB cao nh·∫•t
        let maxAvgScore = -1;
        let bestGroup = "N/A";

        for (const [group, stats] of Object.entries(groupScores)) {
            const avg = stats.total / stats.count;
            if (avg > maxAvgScore) {
                maxAvgScore = avg;
                bestGroup = group;
            }
        }

        // --- Hi·ªÉn th·ªã UI ---
        document.getElementById('results-area').style.display = 'flex';
        document.getElementById('data-table').style.display = 'table';

        document.getElementById('highest-group').textContent = "Nh√≥m " + bestGroup;
        document.getElementById('highest-score').textContent = `ƒêi·ªÉm trung b√¨nh: ${maxAvgScore >= 0 ? maxAvgScore.toFixed(2) : 0}`;

        document.getElementById('longest-group').textContent = "Nh√≥m " + longestCommentGroup;
        document.getElementById('longest-length').textContent = maxCommentLength;
        
        const displayContent = longestCommentContent.length > 100 
            ? longestCommentContent.substring(0, 100) + "..." 
            : longestCommentContent;
        document.getElementById('longest-content').textContent = displayContent || "(Kh√¥ng c√≥ n·ªôi dung)";
    }
</script>

</body>
</html>